# issue streamingについて、「行ごとに、演奏予定時刻を算出し、その50ms前に予約をする」という仕様どおりになっているか調査する #72
[issues #72](https://github.com/cat2151/tonejs-json-sequencer/issues/72)

## 調査結果

### 結論：✅ 仕様どおりに実装されている

現在の実装は、「行ごとに、演奏予定時刻を算出し、その50ms前に予約をする」という仕様に正しく準拠しています。

### 実装の仕組み

1. **playボタンを押した瞬間の時刻を保存**
   - `src/ndjson-streaming.ts` の `initializePlayback()` 関数（192行目）
   - `startTime = Tone.now() + 50ms` として保存
   - すべてのイベントのスケジューリングの基準時刻となる

2. **ジッター対策として50msバッファを使用**
   - JavaScript実行のジッター補償
   - オーディオコンテキストのスケジューリング時間確保
   - イベント処理のオーバーヘッド対策

3. **継続的な処理ループ**
   - `processEvents()` 関数が `requestAnimationFrame` で継続実行（約60fps、16ms間隔）
   - 各イテレーションで：
     - 現在時刻とlookahead窓（現在時刻 + 50ms）を計算
     - 各イベントの絶対再生時刻（startTime + イベント時刻）を計算
     - 絶対時刻がlookahead窓内に入ったイベントをスケジュール
     - 重複スケジュールを防ぐため処理済みマークを付ける

### タイミングの例

```
T0 = 10.000秒（playボタンを押した瞬間）
startTime = 10.050秒（T0 + 50ms）

イベント1: 時刻 = 0秒（0:0:0）
  絶対時刻 = 10.050秒
  最初の処理ループでスケジュール：
    現在時刻 ≈ 10.000秒、lookahead時刻 ≈ 10.050秒
    10.050 <= 10.050 ✓

イベント2: 時刻 = 0.5秒（0:0:2 @ 120 BPM）
  絶対時刻 = 10.550秒
  スケジュールされるタイミング：
    現在時刻 ≈ 10.500秒、lookahead時刻 ≈ 10.550秒
    10.550 <= 10.550 ✓
```

### 詳細な調査資料

詳細な分析は [72-investigation.md](./72-investigation.md) を参照してください。

### コードへの追加ドキュメント

仕様を明確にするため、以下のコメントを追加しました：
- `initializePlayback()` 関数：startTime設定の目的と仕組み
- `processEvents()` 関数：タイミング仕様の全体的な説明
- イベントスケジューリング部分：absoluteTime計算の詳細説明

