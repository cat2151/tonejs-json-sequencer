# NDJSON Streaming アーキテクチャ分析

## 背景

このドキュメントは、NDJSON streaming機能を実現するための上位レイヤーの実装方針について、アーキテクチャの選択肢を洗い出し、メリット・デメリットを分析します。

README.ja.mdの設計思想にあるように、tonejs-json-sequencerのコアは単一elementを受け取るシンプルな実装とし、シーケンスやNDJSONストリーミングは上位レイヤーで扱うことが方針です。

## 選択肢

### 選択肢A: 別リポジトリに上位レイヤーを実装

NDJSON streaming機能を扱う上位レイヤーを、新しい独立したリポジトリとして開発する。

#### メリット

1. **責任の分離と単一責任原則**
   - tonejs-json-sequencerは低レベルのイベント処理に集中できる
   - 上位レイヤーはストリーミング、シーケンス管理、ループ処理などに特化できる
   - 各リポジトリが明確な役割を持ち、理解しやすい

2. **tonejs-json-sequencerのシンプルさと堅牢性の維持**
   - コアライブラリが小さく、軽量に保たれる
   - 依存関係が最小限に抑えられる
   - セキュリティ面での攻撃対象領域が小さい
   - バグ修正やメンテナンスが容易

3. **独立したバージョン管理**
   - 各レイヤーが独立したリリースサイクルを持てる
   - コアライブラリに破壊的変更がなくても、上位レイヤーを進化させられる
   - セマンティックバージョニングが明確になる

4. **柔軟な実装選択**
   - 上位レイヤーで異なる技術スタックを選択できる（例：React、Vue、Node.jsなど）
   - コアライブラリの制約に縛られずに実装できる
   - 複数の上位レイヤー実装（例：ブラウザ用、Node.js用）を別々に開発できる

5. **段階的な採用**
   - ユーザーは必要な機能だけをインストールできる
   - コアライブラリだけを使いたいユーザーは、不要な機能を含まない
   - バンドルサイズが最適化される

6. **エコシステムの拡張性**
   - コミュニティが異なる上位レイヤーを開発しやすい
   - tonejs-mml-to-jsonのように、別の用途の上位レイヤーも作りやすい
   - エコシステムが自然に広がりやすい

#### デメリット

1. **開発・メンテナンスの複雑さ**
   - 複数リポジトリの管理が必要（CI/CD、issue tracking、PRなど）
   - リポジトリ間の同期が課題になる可能性
   - 統合テストの設定が複雑になる

2. **ユーザー体験の分断**
   - ユーザーが複数のパッケージをインストールする必要がある
   - ドキュメントが分散する可能性
   - バージョン互換性の管理が複雑（どのバージョン同士が互換性があるか）

3. **初期開発コストの増加**
   - 新しいリポジトリのセットアップ（CI、テスト環境、ドキュメントなど）
   - パッケージ公開の設定（npm、バージョン管理など）
   - 初期の学習曲線が高くなる可能性

4. **発見可能性の低下**
   - ユーザーが上位レイヤーの存在を知らない可能性
   - 検索性が低下する（別々のリポジトリ名）
   - メインリポジトリからの適切なリンクが必要

### 選択肢B: このリポジトリに上位レイヤーを実装

tonejs-json-sequencerリポジトリ内に、NDJSONストリーミング機能を追加する。

#### メリット

1. **統合された開発体験**
   - 1つのリポジトリで完結するため管理が簡単
   - issueやPRが集約される
   - CI/CDパイプラインが統一される

2. **ユーザーの利便性**
   - 1つのパッケージをインストールするだけで全機能が使える
   - ドキュメントが1箇所にまとまる
   - バージョン互換性の心配が不要

3. **開発効率**
   - モノリポジトリ的なアプローチで、リファクタリングが容易
   - インターフェース変更時の調整が簡単
   - 統合テストが書きやすい

4. **発見可能性の向上**
   - ユーザーがすべての機能を1箇所で見つけられる
   - 検索やドキュメント探索が簡単
   - 例の共有が容易

5. **初期開発の速度**
   - すぐに開発を始められる（新しいリポジトリのセットアップ不要）
   - 実験的な機能を試しやすい
   - プロトタイプが素早く作れる

#### デメリット

1. **スコープの拡大**
   - ライブラリの責任範囲が広がる
   - 「軽量ライブラリ」というコンセプトが薄れる可能性
   - 理解すべきコードベースが大きくなる

2. **依存関係の増加**
   - 上位レイヤーが必要とする依存パッケージが増える
   - バンドルサイズが大きくなる可能性
   - セキュリティリスクが増加する

3. **バージョン管理の複雑さ**
   - コアと上位レイヤーの変更が混在する
   - 破壊的変更の影響範囲が広がる
   - セマンティックバージョニングが曖昧になる可能性

4. **柔軟性の低下**
   - 上位レイヤーの実装が1つに固定される
   - 異なるアプローチの実装が難しい
   - ユーザーが不要な機能も含まれる

5. **設計の複雑さ**
   - コアと上位レイヤーの境界を明確にする必要がある
   - モジュール分割が適切でないと、密結合になるリスク
   - テストの分離が難しくなる可能性

## 比較表

| 観点 | 別リポジトリ（A） | 同じリポジトリ（B） |
|------|------------------|-------------------|
| コアのシンプルさ | ◎ 最もシンプルに保てる | △ 複雑になる可能性 |
| 開発の容易さ | △ 複数リポジトリ管理が必要 | ◎ 1箇所で完結 |
| ユーザー体験 | △ 複数パッケージが必要 | ◎ 1パッケージで完結 |
| バンドルサイズ | ◎ 必要な分だけ | △ 全機能が含まれる |
| 拡張性 | ◎ 新しい実装が作りやすい | △ 1つの実装に固定 |
| メンテナンス性 | △ 複数箇所の管理 | ◎ 集中管理 |
| 初期コスト | △ セットアップが必要 | ◎ すぐに開始可能 |
| セキュリティ | ◎ 攻撃対象領域が小さい | △ 依存関係が増える |

## 推奨アプローチ

### フェーズ1（現在）: 同じリポジトリで実験

**推奨: 選択肢B（このリポジトリに実装）**

理由：
1. プロジェクトがまだ初期段階であり、迅速な実験と検証が重要
2. NDJSONストリーミングの最適な実装方法がまだ確立していない
3. ユーザーフィードバックを集めながら、設計を改善する必要がある
4. 初期開発コストを抑え、素早く価値を提供できる

実装方針：
- `src/streaming/` ディレクトリを作成し、NDJSON関連機能を配置
- コアの `event-scheduler.ts` とは明確に分離
- モジュール境界を意識した設計
- 将来の分離を考慮したインターフェース設計

### フェーズ2（将来）: 成熟後に分離を検討

NDJSONストリーミング機能が安定し、以下の条件が揃ったら分離を検討：

1. **機能の安定性**
   - APIが安定し、破壊的変更が少なくなった
   - ユースケースが明確になった

2. **エコシステムの成長**
   - 複数の上位レイヤー実装のニーズが出てきた
   - コミュニティからの貢献が増えた

3. **コアのシンプルさへの脅威**
   - コアライブラリが複雑になってきた
   - バンドルサイズが問題になってきた

分離時の移行戦略：
1. 新しいリポジトリ `tonejs-json-sequencer-streaming` を作成
2. モノレポ構造を検討（lernaやnxの使用）
3. 既存ユーザーへの移行ガイドを提供
4. 非推奨期間を設けて段階的に移行

## 具体的な実装の進め方（フェーズ1）

### ディレクトリ構造

```
src/
├── index.ts              # メインのエクスポート
├── types.ts              # 共通型定義
├── sequencer-nodes.ts    # ノード管理（コア）
├── node-factory.ts       # ノード生成（コア）
├── event-scheduler.ts    # イベント実行（コア）
├── streaming/            # 上位レイヤー（新規）
│   ├── index.ts          # ストリーミング関連のエクスポート
│   ├── ndjson-player.ts  # NDJSONプレイヤー
│   ├── sequence-loop.ts  # ループ機能
│   └── types.ts          # ストリーミング用型定義
└── demo/                 # デモアプリケーション
```

### パッケージエクスポート戦略

コアと上位レイヤーを明確に分離したエクスポート：

```typescript
// メインエクスポート（コア機能）
export * from './sequencer-nodes';
export * from './node-factory';
export * from './event-scheduler';
export * from './types';

// オプショナルエクスポート（上位レイヤー）
export * as streaming from './streaming';
```

これにより：
- コア機能だけを使いたいユーザーは、従来通り使える
- ストリーミング機能を使いたいユーザーは、`streaming` 名前空間からインポートできる
- 将来の分離時に、インターフェースが似た形で移行できる

### ドキュメント戦略

1. README.md
   - コア機能を説明
   - ストリーミング機能は別セクションで説明
   - 「上位レイヤー」であることを明示

2. docs/streaming.md（新規）
   - NDJSONストリーミングの詳細ドキュメント
   - 使用例とベストプラクティス
   - 将来的に分離する可能性を記載

3. examples/
   - コア機能の例: examples/basic/
   - ストリーミングの例: examples/streaming/

## まとめ

**現時点の推奨**: 同じリポジトリに実装（選択肢B）

理由：
1. 迅速な開発と検証が可能
2. 初期段階では統合された開発体験が重要
3. 将来の分離を考慮した設計により、後で移行可能
4. プロジェクトの成長に応じて柔軟に対応できる

**重要な設計原則**：
- モジュール境界を明確にする
- 疎結合な設計を心がける
- 将来の分離を視野に入れたインターフェース設計
- ドキュメントで「上位レイヤー」であることを明示

この戦略により、現在は開発速度を優先しつつ、将来の分離オプションも保持できます。プロジェクトが成熟し、エコシステムが成長した段階で、再度評価して分離を決定できます。
