<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tone.js JSON Sequencer - NDJSONストリーミングデモ</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="streaming-demo.css">
</head>
<body>
  <h1>NDJSONストリーミングデモ</h1>
  
  <p style="margin: 10px 0;">
    <a href="index.html">← メインデモに戻る</a> | 
    <a href="offline-rendering.html">オフラインレンダリングデモ →</a>
  </p>
  
  <div class="collapsible-section">
    <button class="collapsible-button" id="aboutButton" aria-expanded="false" aria-controls="aboutContent">📖 このデモについて</button>
    <div class="collapsible-content" id="aboutContent">
      <p><strong>🎵 Streaming（ストリーミング再生）方式</strong></p>
      <ul>
        <li><strong>ライブ編集:</strong> 再生中にテキストエリアでシーケンスを編集 - 変更はリアルタイムに反映されます</li>
        <li><strong>ループ再生:</strong> ループモードを有効にすると、シーケンスを連続再生できます</li>
        <li><strong>50ms先読み:</strong> スムーズな再生のため、イベントは50msの先読みでスケジュールされます</li>
        <li><strong>デバッグモード:</strong> 詳細なタイミングとスケジューリング情報を確認できます</li>
      </ul>
      <div class="hint-box">
        <strong>💡 ヒント:</strong> シーケンス全体を一括でレンダリングする場合は、<a href="offline-rendering.html">オフラインレンダリングデモ</a>をご利用ください（One-shot方式）
      </div>
    </div>
  </div>

  <div class="collapsible-section">
    <button class="collapsible-button" id="usageButton" aria-expanded="false" aria-controls="usageContent">📝 使い方</button>
    <div class="collapsible-content" id="usageContent">
      <ol>
        <li><strong>再生:</strong> 「再生」ボタンをクリックすると、50msの先読みスケジューリングで再生が開始されます</li>
        <li><strong>ライブ編集:</strong> 再生中にテキストエリアでシーケンスを編集 - 変更は即座に反映されます</li>
        <li><strong>ループ:</strong> 「ループ再生」を有効にすると、シーケンスを連続的に繰り返し再生できます</li>
        <li><strong>デバッグ:</strong> 「デバッグモード」を有効にすると、イベントのスケジューリングとタイミングの詳細情報が表示されます</li>
        <li><strong>停止:</strong> 「停止」ボタンをクリックすると、再生が停止してリセットされます</li>
      </ol>
      <p><strong>📝 Note:</strong> この方式は<strong>リアルタイムストリーミング再生</strong>です。ライブ編集や連続再生が可能で、対話的な音楽制作に最適です。</p>
    </div>
  </div>

  <div class="streaming-controls">
    <button id="playButton" autofocus>再生</button>
    <button id="stopButton">停止</button>
    <label>
      <input type="checkbox" id="loopCheckbox" checked>
      ループ再生
    </label>
    <label>
      <input type="checkbox" id="debugCheckbox">
      デバッグモード
    </label>
    <select id="sequenceSelector">
      <!-- Options populated by JavaScript -->
    </select>
  </div>

  <div class="streaming-controls">
    <label style="font-weight: bold; margin-right: 10px;">編集の反映方式:</label>
    <label>
      <input type="radio" name="updateMode" id="updateModeManual" value="manual">
      CTRL+SかSHIFT+ENTERで反映
    </label>
    <label>
      <input type="radio" name="updateMode" id="updateModeDebounce" value="debounce" checked>
      デバウンス1秒で反映
    </label>
  </div>

  <div class="status" id="status">ステータス: 停止中</div>

  <div class="debug-section">
    <div class="debug-controls">
      <h3>タイミング可視化:</h3>
    </div>
    <div id="timingVisualization" style="display: none; background: var(--status-bg); color: var(--text-color); border: 1px solid #444; border-radius: 4px; padding: 15px; margin-bottom: 15px; font-family: monospace; font-size: 14px;">
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
        <div>
          <div style="font-weight: bold; margin-bottom: 5px;">📊 イベントスケジューリング:</div>
          <div id="eventSchedulingStats">-</div>
        </div>
        <div>
          <div style="font-weight: bold; margin-bottom: 5px;">🔄 ループタイミング:</div>
          <div id="loopTimingStats">-</div>
        </div>
      </div>
      <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
        <div style="font-weight: bold; margin-bottom: 5px;">凡例:</div>
        <div style="font-size: 12px;">
          ⚪ = タイミング正常 (予約バッファ内) | 🔴 = 遅延 | 🟢 = 早い | 
          ✅ = ループ正常 (±5ms以内) | ⚠️ = ループ遅延 | ⏩ = ループ早い
        </div>
      </div>
    </div>
  </div>

  <div class="debug-section">
    <div class="debug-controls">
      <h3>デバッグ出力:</h3>
      <button id="clearDebugButton">デバッグをクリア</button>
    </div>
    <pre id="debugOutput"></pre>
  </div>

  <h3>シーケンス（NDJSON形式 - 1行につき1イベント）:</h3>
  <div class="sequence-meta">
    <div id="currentLineIndicator" aria-live="off">現在の演奏行: -</div>
  </div>
  <div class="sequence-editor-wrapper">
    <div id="sequenceHighlightOverlay" aria-hidden="true"></div>
    <textarea id="sequenceEditor" rows="30" cols="80"></textarea>
  </div>
  <div class="sequence-debug-wrapper">
    <label for="sequenceEditorDebug" class="sequence-debug-label">デバッグ用NDJSON（行番号付き・読み取り専用）:</label>
    <textarea id="sequenceEditorDebug" rows="30" cols="80" readonly></textarea>
  </div>

  <div class="repo-link-footer">
    <a href="https://github.com/cat2151/tonejs-json-sequencer" target="_blank" rel="noopener noreferrer">Repository</a> |
    <a href="demo-library/index.html">Demo Library</a>
  </div>

  <script src="https://unpkg.com/tone@15.2.7/build/Tone.js"></script>
  <script type="module" src="./dist/demo/streaming.js"></script>
</body>
</html>
